var Compiler=require("./compiler"),formatters=require("./formatters"),Plurals=require("./plurals"),Runtime=require("./runtime");function MessageFormat(e){if(this.pluralFuncs={},"string"==typeof e)this.pluralFuncs[e]=Plurals.get(e),this.defaultLocale=e;else if(Array.isArray(e))e.forEach(function(e){this.pluralFuncs[e]=Plurals.get(e)},this),this.defaultLocale=e[0];else{for(var t in e)if(e.hasOwnProperty(t)){if("function"!=typeof e[t])throw new Error("Expected function value for locale "+JSON.stringify(t));this.pluralFuncs[t]=e[t],this.defaultLocale||(this.defaultLocale=t)}this.defaultLocale?this.hasCustomPluralFuncs=!0:this.defaultLocale=MessageFormat.defaultLocale}this.fmt={},this.runtime=new Runtime(this)}MessageFormat.defaultLocale="en",MessageFormat.escape=function(e,t){var r=t?"[#{}]":"[{}]";return String(e).replace(new RegExp(r,"g"),"'$&'")},MessageFormat.formatters=formatters,MessageFormat.prototype.addFormatters=function(e){for(var t in e)e.hasOwnProperty(t)&&(this.fmt[t]=e[t]);return this},MessageFormat.prototype.disablePluralKeyChecks=function(){for(var e in this.noPluralKeyChecks=!0,this.pluralFuncs)this.pluralFuncs.hasOwnProperty(e)&&(this.pluralFuncs[e].cardinal=[],this.pluralFuncs[e].ordinal=[]);return this},MessageFormat.prototype.setBiDiSupport=function(e){return this.bidiSupport=!!e||void 0===e,this},MessageFormat.prototype.setStrictNumberSign=function(e){return this.strictNumberSign=!!e||void 0===e,this.runtime.setStrictNumber(this.strictNumberSign),this},MessageFormat.prototype.compile=function(e,t){var r={};if(0===Object.keys(this.pluralFuncs).length)if(t){var i=Plurals.get(t,this.noPluralKeyChecks);if(!i)throw new Error("Locale "+JSON.stringify(t)+" not found!");r[t]=i}else t=this.defaultLocale,r=Plurals.getAll(this.noPluralKeyChecks);else if(t){var s=this.pluralFuncs[t];if(!s)throw new Error("Locale "+JSON.stringify(t)+" not found in "+JSON.stringify(this.pluralFuncs)+"!");r[t]=s}else t=this.defaultLocale,r=this.pluralFuncs;var o=new Compiler(this),n=o.compile(e,t,r);if("object"!=typeof e){var a=new Function("number, plural, select, fmt",Compiler.funcname(t),"return "+n),l=this.runtime;return a(l.number,l.plural,l.select,this.fmt,r[t])}var u=this.runtime.toString(r,o)+"\n",f=function e(t,r){if(r||(r=0),"object"!=typeof t)return t;for(var i=[],s="",o=0;o<r;++o)s+="  ";for(var n in t)i.push("\n"+s+"  "+Compiler.propname(n)+": "+e(t[n],r+1));return"{"+i.join(",")+"\n"+s+"}"}(n),c=new Function(u+"return "+f)();if(c.hasOwnProperty("toString"))throw new Error("The top-level message key `toString` is reserved");return c.toString=function(e){return e&&"export default"!==e?-1<e.indexOf(".")?u+e+" = "+f:u+["(function (root, G) {",'  if (typeof define === "function" && define.amd) { define(G); }','  else if (typeof exports === "object") { module.exports = G; }',"  else { "+Compiler.propname(e,"root")+" = G; }","})(this, "+f+");"].join("\n"):u+"export default "+f},c},module.exports=MessageFormat;