!function(g){g.fn.drag=function(t,e,a){var n="string"==typeof t?t:"",r=g.isFunction(t)?t:g.isFunction(e)?e:null;return 0!==n.indexOf("drag")&&(n="drag"+n),a=(t==r?e:a)||{},r?this.on(n,a,r):this.trigger(n)};var h=g.event,n=h.special,f=n.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:!1,drop:!0,click:!1},datakey:"dragdata",noBubble:!0,add:function(t){var a=g.data(this,f.datakey),n=t.data||{};a.related+=1,g.each(f.defaults,function(t,e){void 0!==n[t]&&(a[t]=n[t])})},remove:function(){g.data(this,f.datakey).related-=1},setup:function(){if(!g.data(this,f.datakey)){var t=g.extend({related:0},f.defaults);g.data(this,f.datakey,t),h.add(this,"touchstart mousedown",f.init,t),this.attachEvent&&this.attachEvent("ondragstart",f.dontstart)}},teardown:function(){(g.data(this,f.datakey)||{}).related||(g.removeData(this,f.datakey),h.remove(this,"touchstart mousedown",f.init),f.textselect(!0),this.detachEvent&&this.detachEvent("ondragstart",f.dontstart))},init:function(t){if(!f.touched){var e,a=t.data;if(!(0!=t.which&&0<a.which&&t.which!=a.which)&&!g(t.target).is(a.not)&&(!a.handle||g(t.target).closest(a.handle,t.currentTarget).length)&&(f.touched="touchstart"==t.type?this:null,a.propagates=1,a.mousedown=this,a.interactions=[f.interaction(this,a)],a.target=t.target,a.pageX=t.pageX,a.pageY=t.pageY,a.dragging=null,e=f.hijack(t,"draginit",a),a.propagates))return(e=f.flatten(e))&&e.length&&(a.interactions=[],g.each(e,function(){a.interactions.push(f.interaction(this,a))})),a.propagates=a.interactions.length,!1!==a.drop&&n.drop&&n.drop.handler(t,a),f.textselect(!1),f.touched?h.add(f.touched,"touchmove touchend",f.handler,a):h.add(document,"mousemove mouseup",f.handler,a),!(!f.touched||a.live)&&void 0}},interaction:function(t,e){var a=t&&t.ownerDocument&&g(t)[e.relative?"position":"offset"]()||{top:0,left:0};return{drag:t,callback:new f.callback,droppable:[],offset:a}},handler:function(t){var e=t.data;switch(t.type){case!e.dragging&&"touchmove":t.preventDefault();case!e.dragging&&"mousemove":if(Math.pow(t.pageX-e.pageX,2)+Math.pow(t.pageY-e.pageY,2)<Math.pow(e.distance,2))break;t.target=e.target,f.hijack(t,"dragstart",e),e.propagates&&(e.dragging=!0);case"touchmove":t.preventDefault();case"mousemove":if(e.dragging){if(f.hijack(t,"drag",e),e.propagates){!1!==e.drop&&n.drop&&n.drop.handler(t,e);break}t.type="mouseup"}case"touchend":case"mouseup":default:f.touched?h.remove(f.touched,"touchmove touchend",f.handler):h.remove(document,"mousemove mouseup",f.handler),e.dragging&&(!1!==e.drop&&n.drop&&n.drop.handler(t,e),f.hijack(t,"dragend",e)),f.textselect(!0),!1===e.click&&e.dragging&&g.data(e.mousedown,"suppress.click",(new Date).getTime()+5),e.dragging=f.touched=!1}},hijack:function(a,n,r,t,e){if(r){var o,i,d,s={event:a.originalEvent,type:a.type},c=n.indexOf("drop")?"drag":"drop",l=t||0,p=isNaN(t)?r.interactions.length:t;a.type=n;var u=function(){};a.originalEvent=new jQuery.Event(s.event,{preventDefault:u,stopPropagation:u,stopImmediatePropagation:u}),r.results=[];do{if(i=r.interactions[l]){if("dragend"!==n&&i.cancelled)continue;d=f.properties(a,r,i),i.results=[],g(e||i[c]||r.droppable).each(function(t,e){if(d.target=e,!(a.isPropagationStopped=function(){return!1})===(o=e?h.dispatch.call(e,a,d):null)?("drag"==c&&(i.cancelled=!0,r.propagates-=1),"drop"==n&&(i[c][t]=null)):"dropinit"==n&&i.droppable.push(f.element(o)||e),"dragstart"==n&&(i.proxy=g(f.element(o)||i.drag)[0]),i.results.push(o),delete a.result,"dropinit"!==n)return o}),r.results[l]=f.flatten(i.results),"dropinit"==n&&(i.droppable=f.flatten(i.droppable)),"dragstart"!=n||i.cancelled||d.update()}}while(++l<p);return a.type=s.type,a.originalEvent=s.event,f.flatten(r.results)}},properties:function(t,e,a){var n=a.callback;return n.drag=a.drag,n.proxy=a.proxy||a.drag,n.startX=e.pageX,n.startY=e.pageY,n.deltaX=t.pageX-e.pageX,n.deltaY=t.pageY-e.pageY,n.originalX=a.offset.left,n.originalY=a.offset.top,n.offsetX=n.originalX+n.deltaX,n.offsetY=n.originalY+n.deltaY,n.drop=f.flatten((a.drop||[]).slice()),n.available=f.flatten((a.droppable||[]).slice()),n},element:function(t){if(t&&(t.jquery||1==t.nodeType))return t},flatten:function(t){return g.map(t,function(t){return t&&t.jquery?g.makeArray(t):t&&t.length?f.flatten(t):t})},textselect:function(t){g(document)[t?"off":"on"]("selectstart",f.dontstart).css("MozUserSelect",t?"":"none"),document.unselectable=t?"off":"on"},dontstart:function(){return!1},callback:function(){}};f.callback.prototype={update:function(){n.drop&&this.available.length&&g.each(this.available,function(t){n.drop.locate(this,t)})}};var e=h.dispatch;h.dispatch=function(t){if(!(0<g.data(this,"suppress."+t.type)-(new Date).getTime()))return e.apply(this,arguments);g.removeData(this,"suppress."+t.type)},n.draginit=n.dragstart=n.dragend=f}(jQuery);