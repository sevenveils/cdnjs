L.BingLayer=L.TileLayer.extend({options:{imagerySet:"Aerial",culture:"",style:"",retinaDpi:"d2",attribution:"Bing",minZoom:1,maxZoom:21,applyMaxNativeZoom:"auto"},initialize:function(t,e){"object"==typeof t&&(e=t,t=!1),L.TileLayer.prototype.initialize.call(this,null,e),(e=this.options).key=e.key||e.bingMapsKey,e.imagerySet=e.imagerySet||e.type,t&&(e.key=t),"auto"!==e.applyMaxNativeZoom||e.maxNativeZoom||(e.applyMaxNativeZoom="Road"===e.imagerySet||"Aerial"===e.imagerySet.substring(0,6))},tile2quad:function(t,e,i){for(var r="",a=i;0<a;a--){var o=0,n=1<<a-1;0!=(t&n)&&(o+=1),0!=(e&n)&&(o+=2),r+=o}return r},getTileUrl:function(t){var e={subdomain:this._getSubdomain(t),quadkey:this.tile2quad(t.x,t.y,this._getZoomForUrl()),culture:this.options.culture};return L.Util.template(this._url,e)},callRestService:function(t,e,i){i=i||this;for(var r="_bing_metadata_"+L.Util.stamp(this);window[r];)r+="_";t+="&jsonp="+r;var a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("src",t),window[r]=function(t){if(delete window[r],a.remove(),t.errorDetails)throw new Error(t.errorDetails);e.call(i,t)},document.body.appendChild(a)},_makeApiUrl:function(t,e,i){var r={version:"v1",restApi:t,resourcePath:e};i=L.extend({key:this.options.key},i);return L.Util.template("https://dev.virtualearth.net/REST/{version}/{restApi}/{resourcePath}",r)+L.Util.getParamString(i)},loadMetadata:function(){if(!this.metaRequested){this.metaRequested=!0;var i=this.options,t=this._makeApiUrl("Imagery/Metadata",i.imagerySet,{UriScheme:"https",include:"ImageryProviders",culture:i.culture,style:i.style});this.callRestService(t,function(t){var e=t.resourceSets[0].resources[0];if(!e.imageUrl)throw new Error("imageUrl not found in response");e.imageUrlSubdomains&&(i.subdomains=e.imageUrlSubdomains),this._providers=e.imageryProviders?this._prepAttrBounds(e.imageryProviders):[],this._attributions=[],this._url=e.imageUrl,i.retinaDpi&&i.detectRetina&&i.zoomOffset&&(this._url+="&dpi="+i.retinaDpi),this.fire("load",{meta:t}),this._map&&this._update()})}},_prepAttrBounds:function(t){return t.forEach(function(t){t.coverageAreas.forEach(function(t){t.bounds=L.latLngBounds([t.bbox[0],t.bbox[1]],[t.bbox[2],t.bbox[3]])})}),t},applyMaxNativeZoom:function(t){var r=this.options,e=this._makeApiUrl("Imagery/BasicMetadata",L.Util.template("{imagerySet}/{centerPoint}",{imagerySet:r.imagerySet,centerPoint:L.Util.template("{lat},{lng}",t)})),a=r.zoomOffset||0;return this._findVintage(e,r.maxZoom+a,function(t){if(t){t-=a;var e=r.maxNativeZoom||r.maxZoom;r.maxNativeZoom=t;var i=this._map&&this._map.getZoom();i&&(t<e&&t<i||e<t&&e<i)&&this._resetView()}}),this},_findVintage:function(e,i,r,a){this.callRestService(e+"&zoomLevel="+i,function(t){if(t.resourceSets[0].resources[0].vintageStart||0===i)return r.call(a||this,i);this._findVintage(e,i-1,r,a)})},_update:function(t){this._url&&(L.GridLayer.prototype._update.call(this,t),this._update_attribution())},_update_attribution:function(e){var i=this._map.attributionControl;if(i){var r=this._map.getBounds();r=L.latLngBounds(r.getSouthWest().wrap(),r.getNorthEast().wrap());var a=this._getZoomForUrl(),t=this._providers.map(function(t){return!e&&t.coverageAreas.some(function(t){return a<=t.zoomMax&&a>=t.zoomMin&&r.intersects(t.bounds)})});t.forEach(function(t,e){t!=this._attributions[e]&&(t?i.addAttribution(this._providers[e].attribution):i.removeAttribution(this._providers[e].attribution))},this),this._attributions=t}else this._attributions={}},onAdd:function(t){this.loadMetadata(),this.options.applyMaxNativeZoom&&this.applyMaxNativeZoom(t.getCenter()),L.GridLayer.prototype.onAdd.call(this,t)},onRemove:function(t){this._update_attribution(!0),L.GridLayer.prototype.onRemove.call(this,t)}}),L.bingLayer=function(t,e){return new L.BingLayer(t,e)};