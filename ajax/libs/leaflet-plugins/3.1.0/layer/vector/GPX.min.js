L.GPX=L.FeatureGroup.extend({initialize:function(e,t){L.Util.setOptions(this,t),this._gpx=e,this._layers={},e&&this.addGPX(e,t,this.options.async)},loadXML:function(e,t,n,a){void 0===a&&(a=this.options.async),void 0===n&&(n=this.options);var r=new window.XMLHttpRequest;r.open("GET",e,a);try{r.overrideMimeType("text/xml")}catch(e){}r.onreadystatechange=function(){4===r.readyState&&200===r.status&&t(r.responseXML,n)},r.send(null)},_humanLen:function(e){return e<2e3?e.toFixed(0)+" m":(e/1e3).toFixed(1)+" km"},_polylineLen:function(e){for(var t=e._latlngs,n=0,a=null,r=0;r<t.length;r++)r&&a&&(n+=a.distanceTo(t[r])),a=t[r];return n},addGPX:function(e,t,n){var a=this;this.loadXML(e,function(e,t){a._addGPX(e,t)},t,n)},_addGPX:function(e,t){var n=this.parseGPX(e,t);n&&(this.addLayer(n),this.fire("loaded"))},parseGPX:function(e,t){var n,a,r,i=[],s=!1,o=[["rte","rtept"],["trkseg","trkpt"]];for(n=0;n<o.length;n++)for(r=e.getElementsByTagName(o[n][0]),a=0;a<r.length;a++)for(var l=this.parse_trkseg(r[a],e,t,o[n][1]),h=0;h<l.length;h++)this.parse_name(r[a],l[h])&&(s=!0),i.push(l[h]);if(r=e.getElementsByTagName("wpt"),!1!==t.display_wpt)for(a=0;a<r.length;a++){var d=this.parse_wpt(r[a],e,t);d&&(this.parse_name(r[a],d)&&(s=!0),i.push(d))}if(i.length){var p=i[0];return 1<i.length&&(p=new L.FeatureGroup(i)),s||this.parse_name(e,p),p}},parse_name:function(e,t){var n,a,r,i,s="",o="",l=0;for((a=e.getElementsByTagName("name")).length&&(r=a[0].childNodes[0].nodeValue),a=e.getElementsByTagName("desc"),n=0;n<a.length;n++)for(var h=0;h<a[n].childNodes.length;h++)o+=a[n].childNodes[h].nodeValue;return(a=e.getElementsByTagName("link")).length&&(i=a[0].getAttribute("href")),t instanceof L.Path&&(l=this._polylineLen(t)),r&&(s+="<h2>"+r+"</h2>"+o),l&&(s+="<p>"+this._humanLen(l)+"</p>"),i&&(s+='<p><a target="_blank" href="'+i+'">[...]</a></p>'),t&&void 0===t._popup&&t.bindPopup(s),s},parse_trkseg:function(e,t,n,a){var r=e.getElementsByTagName(a);if(!r.length)return[];for(var i=[],s=0;s<r.length;s++){var o=new L.LatLng(r[s].getAttribute("lat"),r[s].getAttribute("lon"));for(var l in o.meta={},r[s].childNodes){var h=r[s].childNodes[l];h.tagName&&(o.meta[h.tagName]=h.textContent)}i.push(o)}var d=[new L.Polyline(i,n)];return this.fire("addline",{line:d}),d},parse_wpt:function(e,t,n){for(var a=new L.Marker(new L.LatLng(e.getAttribute("lat"),e.getAttribute("lon")),n),r={},i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];"#text"!==s.nodeName&&(r[s.nodeName]=s.textContent)}return this.fire("addpoint",{point:a,attributes:r}),a}});