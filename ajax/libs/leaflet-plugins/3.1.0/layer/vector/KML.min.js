L.KML=L.FeatureGroup.extend({options:{async:!0},initialize:function(e,t){L.Util.setOptions(this,t),this._kml=e,this._layers={},e&&this.addKML(e,t,this.options.async)},loadXML:function(e,t,n,r){void 0===r&&(r=this.options.async),void 0===n&&(n=this.options);var a=new window.XMLHttpRequest;if(void 0===a.withCredentials&&void 0!==window.XDomainRequest){var o=new window.XDomainRequest;o.open("GET",e,r),o.onprogress=function(){},o.ontimeout=function(){},o.onerror=function(){},o.onload=function(){if(o.responseText){var e=new window.ActiveXObject("Microsoft.XMLDOM");e.loadXML(o.responseText),t(e,n)}},setTimeout(function(){o.send()},0)}else{a.open("GET",e,r),a.setRequestHeader("Accept","application/vnd.google-earth.kml+xml");try{a.overrideMimeType("text/xml")}catch(e){}a.onreadystatechange=function(){4===a.readyState&&200===a.status&&t(a.responseXML,n)},a.send(null)}},addKML:function(e,t,n){var r=this;this.loadXML(e,function(e){r._addKML(e)},t,n)},_addKML:function(e){var t=L.KML.parseKML(e);if(t&&t.length){for(var n=0;n<t.length;n++)this.fire("addlayer",{layer:t[n]}),this.addLayer(t[n]);this.latLngs=L.KML.getLatLngs(e),this.fire("loaded")}},latLngs:[]}),L.Util.extend(L.KML,{parseKML:function(e){var t=this.parseStyles(e);this.parseStyleMap(e,t);for(var n,r=e.getElementsByTagName("Folder"),a=[],o=0;o<r.length;o++)this._check_folder(r[o])&&(n=this.parseFolder(r[o],t))&&a.push(n);r=e.getElementsByTagName("Placemark");for(var s=0;s<r.length;s++)this._check_folder(r[s])&&(n=this.parsePlacemark(r[s],e,t))&&a.push(n);r=e.getElementsByTagName("GroundOverlay");for(var i=0;i<r.length;i++)(n=this.parseGroundOverlay(r[i]))&&a.push(n);return a},_check_folder:function(e,t){for(e=e.parentNode;e&&"Folder"!==e.tagName;)e=e.parentNode;return!e||e===t},parseStyles:function(e){for(var t={},n=e.getElementsByTagName("Style"),r=0,a=n.length;r<a;r++){var o=this.parseStyle(n[r]);if(o)t["#"+o.id]=o}return t},parseStyle:function(e){var t,n,r={},a={},i={},l={color:!0,width:!0,Icon:!0,href:!0,hotSpot:!0};function h(e){for(var t={},n=0;n<e.childNodes.length;n++){var r=e.childNodes[n],a=r.tagName;if(l[a])if("hotSpot"===a)for(var o=0;o<r.attributes.length;o++)t[r.attributes[o].name]=r.attributes[o].nodeValue;else{var s=r.childNodes[0].nodeValue;"color"===a?(t.opacity=parseInt(s.substring(0,2),16)/255,t.color="#"+s.substring(6,8)+s.substring(4,6)+s.substring(2,4)):"width"===a?t.weight=s:"Icon"===a?(i=h(r)).href&&(t.href=i.href):"href"===a&&(t.href=s)}}return t}return(t=e.getElementsByTagName("LineStyle"))&&t[0]&&(r=h(t[0])),(t=e.getElementsByTagName("PolyStyle"))&&t[0]&&(a=h(t[0])),a.color&&(r.fillColor=a.color),a.opacity&&(r.fillOpacity=a.opacity),(t=e.getElementsByTagName("IconStyle"))&&t[0]&&(i=h(t[0])),i.href&&(r.icon=new L.KMLIcon({iconUrl:i.href,shadowUrl:null,anchorRef:{x:i.x,y:i.y},anchorType:{x:i.xunits,y:i.yunits}})),(n=e.getAttribute("id"))&&r&&(r.id=n),r},parseStyleMap:function(e,t){for(var n=e.getElementsByTagName("StyleMap"),r=0;r<n.length;r++){var a,o,s,i=n[r];(a=i.getElementsByTagName("key"))&&a[0]&&(o=a[0].textContent),(a=i.getElementsByTagName("styleUrl"))&&a[0]&&(s=a[0].textContent),"normal"===o&&(t["#"+i.getAttribute("id")]=t[s])}},parseFolder:function(e,t){var n,r,a=[];n=e.getElementsByTagName("Folder");for(var o=0;o<n.length;o++)this._check_folder(n[o],e)&&(r=this.parseFolder(n[o],t))&&a.push(r);n=e.getElementsByTagName("Placemark");for(var s=0;s<n.length;s++)this._check_folder(n[s],e)&&(r=this.parsePlacemark(n[s],e,t))&&a.push(r);n=e.getElementsByTagName("GroundOverlay");for(var i=0;i<n.length;i++)this._check_folder(n[i],e)&&(r=this.parseGroundOverlay(n[i]))&&a.push(r);if(a.length)return 1===a.length?a[0]:new L.FeatureGroup(a)},parsePlacemark:function(e,t,n,r){var a,o,s,i,l,h=r||{};for(l=e.getElementsByTagName("styleUrl"),o=0;o<l.length;o++){var g=l[o].childNodes[0].nodeValue;for(var c in n[g])h[c]=n[g][c]}if(e.getElementsByTagName("Style")[0]){var d=this.parseStyle(e);if(d)for(i in d)h[i]=d[i]}var u=["MultiGeometry","MultiTrack","gx:MultiTrack"];for(a in u)for(l=e.getElementsByTagName(u[a]),o=0;o<l.length;o++)return this.parsePlacemark(l[o],t,n,h);var f=[],p=["LineString","Polygon","Point","Track","gx:Track"];for(s in p){var y=p[s];for(l=e.getElementsByTagName(y),o=0;o<l.length;o++){var m=this["parse"+y.replace(/gx:/,"")](l[o],t,h);m&&f.push(m)}}if(f.length){var v=f[0];1<f.length&&(v=new L.FeatureGroup(f));var N,T="";for((l=e.getElementsByTagName("name")).length&&l[0].childNodes.length&&(N=l[0].childNodes[0].nodeValue),l=e.getElementsByTagName("description"),o=0;o<l.length;o++)for(s=0;s<l[o].childNodes.length;s++)T+=l[o].childNodes[s].nodeValue;return N&&v.on("add",function(){v.bindPopup("<h2>"+N+"</h2>"+T)}),v}},parseCoords:function(e){var t=e.getElementsByTagName("coordinates");return this._read_coords(t[0])},parseLineString:function(e,t,n){var r=this.parseCoords(e);if(r.length)return new L.Polyline(r,n)},parseTrack:function(e,t,n){var r=t.getElementsByTagName("gx:coord");0===r.length&&(r=t.getElementsByTagName("coord"));for(var a=[],o=0;o<r.length;o++)a=a.concat(this._read_gxcoords(r[o]));if(a.length)return new L.Polyline(a,n)},parsePoint:function(e,t,n){var r=e.getElementsByTagName("coordinates");if(r.length){var a=r[0].childNodes[0].nodeValue.split(",");return new L.KMLMarker(new L.LatLng(a[1],a[0]),n)}},parsePolygon:function(e,t,n){var r,a,o,s=[],i=[];for(r=e.getElementsByTagName("outerBoundaryIs"),a=0;a<r.length;a++)(o=this.parseCoords(r[a]))&&s.push(o);for(r=e.getElementsByTagName("innerBoundaryIs"),a=0;a<r.length;a++)(o=this.parseCoords(r[a]))&&i.push(o);if(s.length)return n.fillColor&&(n.fill=!0),1===s.length?new L.Polygon(s.concat(i),n):new L.MultiPolygon(s,n)},getLatLngs:function(e){for(var t=e.getElementsByTagName("coordinates"),n=[],r=0;r<t.length;r++)n=n.concat(this._read_coords(t[r]));return n},_read_coords:function(e){var t,n="",r=[];for(t=0;t<e.childNodes.length;t++)n+=e.childNodes[t].nodeValue;for(n=n.split(/[\s\n]+/),t=0;t<n.length;t++){var a=n[t].split(",");a.length<2||r.push(new L.LatLng(a[1],a[0]))}return r},_read_gxcoords:function(e){var t,n=[];return t=e.firstChild.nodeValue.split(" "),n.push(new L.LatLng(t[1],t[0])),n},parseGroundOverlay:function(e){var t=e.getElementsByTagName("LatLonBox")[0],n=new L.LatLngBounds([t.getElementsByTagName("south")[0].childNodes[0].nodeValue,t.getElementsByTagName("west")[0].childNodes[0].nodeValue],[t.getElementsByTagName("north")[0].childNodes[0].nodeValue,t.getElementsByTagName("east")[0].childNodes[0].nodeValue]),l={Icon:!0,href:!0,color:!0};var r={};if(r=function e(t){for(var n={},r={},a=0;a<t.childNodes.length;a++){var o=t.childNodes[a],s=o.tagName;if(l[s]){var i=o.childNodes[0].nodeValue;"Icon"===s?(r=e(o)).href&&(n.href=r.href):"href"===s?n.href=i:"color"===s&&(n.opacity=parseInt(i.substring(0,2),16)/255,n.color="#"+i.substring(6,8)+i.substring(4,6)+i.substring(2,4))}}return n}(e),void 0!==t.getElementsByTagName("rotation")[0]){var a=t.getElementsByTagName("rotation")[0].childNodes[0].nodeValue;r.rotation=parseFloat(a)}return new L.RotatedImageOverlay(r.href,n,{opacity:r.opacity,angle:r.rotation})}}),L.KMLIcon=L.Icon.extend({_setIconStyles:function(e,t){L.Icon.prototype._setIconStyles.apply(this,[e,t]);var n=this.options;this.options.popupAnchor=[0,-.83*e.height],"fraction"===n.anchorType.x&&(e.style.marginLeft=-n.anchorRef.x*e.width+"px"),"fraction"===n.anchorType.y&&(e.style.marginTop=-(1-n.anchorRef.y)*e.height+1+"px"),"pixels"===n.anchorType.x&&(e.style.marginLeft=-n.anchorRef.x+"px"),"pixels"===n.anchorType.y&&(e.style.marginTop=n.anchorRef.y-e.height+1+"px")}}),L.KMLMarker=L.Marker.extend({options:{icon:new L.KMLIcon.Default}}),L.RotatedImageOverlay=L.ImageOverlay.extend({options:{angle:0},_reset:function(){L.ImageOverlay.prototype._reset.call(this),this._rotate()},_animateZoom:function(e){L.ImageOverlay.prototype._animateZoom.call(this,e),this._rotate()},_rotate:function(){if(L.DomUtil.TRANSFORM)this._image.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(L.Browser.ie){var e=this.options.angle*(Math.PI/180),t=Math.cos(e),n=Math.sin(e);this._image.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+t+", M12="+-n+", M21="+n+", M22="+t+")"}},getBounds:function(){return this._bounds}});