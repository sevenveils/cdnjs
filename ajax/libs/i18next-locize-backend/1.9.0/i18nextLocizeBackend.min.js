!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.i18nextLocizeBackend=t()}(this,function(){"use strict";function e(e,t,n){var o;return function(){var i=this,s=arguments,r=function(){o=null,n||e.apply(i,s)},a=n&&!o;clearTimeout(o),o=setTimeout(r,t),a&&e.apply(i,s)}}function t(e,t,n){function o(e){return e&&e.indexOf("###")>-1?e.replace(/###/g,"."):e}for(var i="string"!=typeof t?[].concat(t):t.split(".");i.length>1;){if(!e)return{};var s=o(i.shift());!e[s]&&n&&(e[s]=new n),e=e[s]}return e?{obj:e,k:o(i.shift())}:{}}function n(e,n,o){var i=t(e,n,Object);i.obj[i.k]=o}function o(e,n,o,i){var s=t(e,n,Object),r=s.obj,a=s.k;r[a]=r[a]||[],i&&(r[a]=r[a].concat(o)),i||r[a].push(o)}function i(e,n){var o=t(e,n),i=o.obj,s=o.k;if(i)return i[s]}function s(e){return null==e?"":""+e}function r(e,t,n){for(var o=void 0,i=void 0;o=l.exec(e);)i=o[1].trim(),"string"!=typeof i&&(i=s(i)),i||(i=""),i=function(e){return e.replace(/\$/g,"$$$$")}(i),e=e.replace(o[0],t[i]||i),l.lastIndex=0;return e}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t,n,o,i){try{var s=new(XMLHttpRequest||ActiveXObject)("MSXML2.XMLHTTP.3.0");s.open(o?"POST":"GET",e,1),t.crossDomain||s.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.authorize&&t.apiKey&&s.setRequestHeader("Authorization",t.apiKey),(o||t.setContentTypeJSON)&&s.setRequestHeader("Content-type","application/json"),s.onreadystatechange=function(){s.readyState>3&&n&&n(s.responseText,s)},s.send(JSON.stringify(o))}catch(e){window.console&&console.log(e)}}function c(){return{loadPath:"https://api.locize.io/{{projectId}}/{{version}}/{{lng}}/{{ns}}",privatePath:"https://api.locize.io/private/{{projectId}}/{{version}}/{{lng}}/{{ns}}",pullPath:"https://api.locize.io/pull/{{projectId}}/{{version}}/{{lng}}/{{ns}}",getLanguagesPath:"https://api.locize.io/languages/{{projectId}}",addPath:"https://api.locize.io/missing/{{projectId}}/{{version}}/{{lng}}/{{ns}}",updatePath:"https://api.locize.io/update/{{projectId}}/{{version}}/{{lng}}/{{ns}}",referenceLng:"en",crossDomain:!0,setContentTypeJSON:!1,version:"latest",pull:!1,private:!1,whitelistThreshold:.9,failLoadingOnEmptyJSON:!1,allowedAddOrUpdateHosts:["localhost"]}}var l=new RegExp("{{(.+?)}}","g"),p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},d=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),f=function(){function t(e,n,o){a(this,t),e&&e.projectId?this.init(null,e,{},n):this.init(null,n,{},o),this.type="backend"}return d(t,[{key:"init",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=this,i=(arguments[2],arguments[3]);this.options=p({},c(),this.options,n),this.options.pull&&console.warn("deprecated: pull will be removed in future versions and should be replaced with locize private versions");var s=window.location&&window.location.hostname;this.isAddOrUpdateAllowed=!s||this.options.allowedAddOrUpdateHosts.indexOf(s)>-1,"function"==typeof i&&this.getOptions(function(e,t){if(e)return i(e);o.options.referenceLng=n.referenceLng||t.referenceLng||o.options.referenceLng,i(null,t)}),this.queuedWrites={},this.debouncedProcess=e(this.process,1e4)}},{key:"getLanguages",value:function(e){var t=r(this.options.getLanguagesPath,{projectId:this.options.projectId});this.loadUrl(t,{},e)}},{key:"getOptions",value:function(e){var t=this;this.getLanguages(function(n,o){if(n)return e(n);var i=Object.keys(o);if(!i.length)return e(new Error("was unable to load languages via API"));var s=i.reduce(function(e,t){return o[t].isReferenceLanguage&&(e=t),e},""),r=i.reduce(function(e,n){var i=o[n];return i.translated[t.options.version]&&i.translated[t.options.version]>=t.options.whitelistThreshold&&e.push(n),e},[]),a=i.reduce(function(e,t){return t.indexOf("-")>-1||e},!1);e(null,{fallbackLng:s,referenceLng:s,whitelist:r,load:a?"all":"languageOnly"})})}},{key:"read",value:function(e,t,n){var o=void 0,i={};this.options.private?(o=r(this.options.privatePath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version}),i={authorize:!0}):this.options.pull?(o=r(this.options.pullPath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version}),i={authorize:!0}):o=r(this.options.loadPath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version}),this.loadUrl(o,i,n)}},{key:"loadUrl",value:function(e,t,n){var o=this;u(e,p({},this.options,t),function(t,i){if(i.status>=500&&i.status<600)return n("failed loading "+e,!0);if(i.status>=400&&i.status<500)return n("failed loading "+e,!1);var s=void 0,r=void 0;try{s=JSON.parse(t)}catch(t){r="failed parsing "+e+" to json"}return r?n(r,!1):o.options.failLoadingOnEmptyJSON&&!Object.keys(s).length?n("loaded result empty for "+e,!1):void n(null,s)})}},{key:"create",value:function(e,t,n,o,i,s){var r=this;if(i||(i=function(){}),!this.isAddOrUpdateAllowed)return i("host is not allowed to create key.");"string"==typeof e&&(e=[e]),e.forEach(function(e){e===r.options.referenceLng&&r.queue.call(r,r.options.referenceLng,t,n,o,i,s)})}},{key:"update",value:function(e,t,n,o,i,s){var r=this;if(i||(i=function(){}),!this.isAddOrUpdateAllowed)return i("host is not allowed to update key.");s||(s={}),"string"==typeof e&&(e=[e]),s.isUpdate=!0,e.forEach(function(e){e===r.options.referenceLng&&r.queue.call(r,r.options.referenceLng,t,n,o,i,s)})}},{key:"write",value:function(e,t){var o=this;if(!i(this.queuedWrites,["locks",e,t])){var s=r(this.options.addPath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version}),a=r(this.options.updatePath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version}),c=i(this.queuedWrites,[e,t]);if(n(this.queuedWrites,[e,t],[]),c.length){n(this.queuedWrites,["locks",e,t],!0);var l=!1,d=!1,f={},h={};c.forEach(function(e){var t=e.options&&e.options.tDescription?{value:e.fallbackValue||"",context:{text:e.options.tDescription}}:e.fallbackValue||"";e.options&&e.options.isUpdate?(d||(d=!0),h[e.key]=t):(l||(l=!0),f[e.key]=t)});var v=0;l&&v++,d&&v++;var g=function(){--v||(n(o.queuedWrites,["locks",e,t],!1),c.forEach(function(e){e.callback&&e.callback()}),o.debouncedProcess(e,t))};v||g(),l&&u(s,p({authorize:!0},this.options),function(e,t){g()},f),d&&u(a,p({authorize:!0},this.options),function(e,t){g()},h)}}}},{key:"process",value:function(){var e=this;Object.keys(this.queuedWrites).forEach(function(t){"locks"!==t&&Object.keys(e.queuedWrites[t]).forEach(function(n){e.queuedWrites[t][n].length&&e.write(t,n)})})}},{key:"queue",value:function(e,t,n,i,s,r){o(this.queuedWrites,[e,t],{key:n,fallbackValue:i||"",callback:s,options:r}),this.debouncedProcess()}}]),t}();return f.type="backend",f});
