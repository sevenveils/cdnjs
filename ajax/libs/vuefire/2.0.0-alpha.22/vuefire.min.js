/*!
 * vuefire v2.0.0-alpha.22
 * (c) 2019 Eduardo San Martin Morote
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Vuefire={})}(this,function(e){"use strict";function h(e){return Object.defineProperty(e.data(),"id",{value:e.id})}function s(e){return e&&"object"==typeof e}function b(r,i,o,e){void 0===i&&(i={}),void 0===o&&(o=""),void 0===e&&(e=[{},{}]),i=i||{};var t=Object.getOwnPropertyDescriptor(r,"id");return t&&!t.enumerable&&Object.defineProperty(e[0],"id",t),Object.keys(r).reduce(function(e,t){var n=r[t];return!function(e){return e&&e.onSnapshot}(n)?Array.isArray(n)?(e[0][t]=Array(n.length).fill(null),b(n,i[t],o+t+".",[e[0][t],e[1]])):null==n||n instanceof Date||function(e){return e.toDate}(n)||n.longitude&&n.latitude?e[0][t]=n:s(n)?(e[0][t]={},b(n,i[t],o+t+".",[e[0][t],e[1]])):e[0][t]=n:(e[0][t]=i[t]||n.path,e[1][o+t]=n),e},e)}function r(e,t,n){var r=(""+t).split("."),i=r.pop(),o=r.reduce(function(e,t){return e[t]},e);return o.splice?o.splice(i,1,n):o[i]=n}function l(e){var t,n=e.val();return s(n)?t=n:(t={},Object.defineProperty(t,".value",{value:n})),Object.defineProperty(t,".key",{value:e.key}),t}function v(e,t){for(var n=0;n<e.length;n++)if(e[n][".key"]===t)return n;return-1}function y(e){for(var t in e)e[t].unsub()}function m(e,i){var o=e.subs,s=e.refs,f=e.target,u=e.path,c=e.depth,a=e.ops,d=e.resolve,t=Object.keys(s);if(Object.keys(o).filter(function(e){return t.indexOf(e)<0}).forEach(function(e){o[e].unsub(),delete o[e]}),!t.length||++c>i.maxRefDepth)return d(u);var l=0,v=t.length,p=Object.create(null);t.forEach(function(e){var t=o[e],n=s[e],r=u+"."+e;if(p[r]=!0,t){if(t.path===n.path)return;t.unsub()}o[e]={unsub:function(e,t){var n=e.ref,r=e.target,i=e.path,o=e.depth,s=e.resolve,f=e.ops,u=Object.create(null),c=n.onSnapshot(function(e){e.exists?g({snapshot:h(e),target:r,path:i,ops:f,subs:u,depth:o,resolve:s},t):(f.set(r,i,null),s(i))});return function(){c(),y(u)}}({ref:n,target:f,path:r,depth:c,ops:a,resolve:function(e){e in p&&++l>=v&&d(u)}.bind(null,r)},i),path:n.path}})}function g(e,t){var n=e.snapshot,r=e.target,i=e.path,o=e.subs,s=e.ops,f=e.depth;void 0===f&&(f=0);var u=e.resolve;void 0===t&&(t={maxRefDepth:2});var c=b(n,function(e,t){return t.split(".").reduce(function(e,t){return e[t]},e)}(r,i)),a=c[0],d=c[1];s.set(r,i,a),m({data:a,subs:o,refs:d,target:r,path:i,ops:s,depth:f,resolve:u},t)}function o(e){return"object"==typeof e.ref&&(e=e.ref),e}var f={set:function(e,t,n){return r(e,t,n)},add:function(e,t,n){return e.splice(t,0,n)},remove:function(e,t){return e.splice(t,1)}};function u(r,i,o){return new Promise(function(e,t){var n;n=Array.isArray(r[i])?function(e){var t=e.vm,n=e.key,r=e.collection,i=e.resolve,o=e.reject,s=e.ops,f=[];s.set(t,n,f);var u=r.on("child_added",function(e,t){var n=t?v(f,t)+1:0;s.add(f,n,l(e))},o),c=r.on("child_removed",function(e){s.remove(f,v(f,e.key))},o),a=r.on("child_changed",function(e){s.set(f,v(f,e.key),l(e))},o),d=r.on("child_moved",function(e,t){var n=v(f,e.key),r=s.remove(f,n)[0],i=t?v(f,t)+1:0;s.add(f,i,r)},o);return r.once("value",i),function(){r.off("child_added",u),r.off("child_changed",a),r.off("child_removed",c),r.off("child_moved",d)}}({vm:r,key:i,collection:o,resolve:e,reject:t,ops:f}):function(e){var t=e.vm,n=e.key,r=e.document,i=e.resolve,o=e.reject,s=e.ops,f=r.on("value",function(e){s.set(t,n,l(e))},o);return r.once("value",i),function(){r.off("value",f)}}({vm:r,key:i,document:o,resolve:e,reject:t,ops:f}),r._firebaseUnbinds[i]=n})}var c={set:function(e,t,n){return r(e,t,n)},add:function(e,t,n){return e.splice(t,0,n)},remove:function(e,t){return e.splice(t,1)}};function a(e,r){var i=e.vm,o=e.key,s=e.ref,f=e.ops;return void 0===r&&(r={maxRefDepth:2}),new Promise(function(e,t){var n;n=s.where?function(e,c){var o=e.vm,s=e.key,t=e.collection,a=e.ops,d=e.resolve,n=e.reject;void 0===c&&(c={maxRefDepth:2});var f,l=a.set(o,s,[]),u=d,v=[],p={added:function(e){var t=e.newIndex,n=e.doc;v.splice(t,0,Object.create(null));var r=v[t],i=b(h(n)),o=i[0],s=i[1];a.add(l,t,o),m({refs:s,subs:r,target:l,path:t,depth:0,ops:a,resolve:d.bind(null,n)},c)},modified:function(e){var t=e.oldIndex,n=e.newIndex,r=e.doc,i=v.splice(t,1)[0];v.splice(n,0,i);var o=a.remove(l,t)[0],s=b(h(r),o),f=s[0],u=s[1];a.add(l,n,f),m({data:f,refs:u,subs:i,ops:a,target:l,path:n,depth:0,resolve:d},c)},removed:function(e){var t=e.oldIndex;a.remove(l,t),y(v.splice(t,1)[0])}},r=t.onSnapshot(function(e){var t="function"==typeof e.docChanges?e.docChanges():e.docChanges;if(!f&&t.length){f=!0;var n=0,r=t.length,i=t.reduce(function(e,t){return e[t.doc.id]=!1,e},Object.create(null));d=function(e){e.id in i&&++n>=r&&(u(o[s]),d=function(e){})}}t.forEach(function(e){p[e.type](e)}),t.length||d()},n);return function(){r(),v.forEach(y)}}({vm:i,key:o,ops:f,collection:s,resolve:e,reject:t},r):function(e,t){var n=e.vm,r=e.key,i=e.document,o=e.resolve,s=e.reject,f=e.ops,u=Object.create(null);o=function(e,t){var n;return function(){if(!n)return n=!0,e(t())}}(o,function(){return n[r]});var c=i.onSnapshot(function(e){e.exists?g({snapshot:h(e),target:n,path:r,subs:u,ops:f,resolve:o},t):o()},s);return function(){c(),y(u)}}({vm:i,key:o,ops:f,document:s,resolve:e,reject:t},r),i._firestoreUnbinds[o]=n})}e.firestorePlugin=function(e,t){void 0===t&&(t={});var r=t.bindName;void 0===r&&(r="$bind");var i=t.unbindName;void 0===i&&(i="$unbind");var n=e.config.optionMergeStrategies;n.firestore=n.provide,e.mixin({created:function(){var t=this,e=this.$options.firestore;this._firestoreUnbinds=Object.create(null),this.$firestoreRefs=Object.create(null);var n="function"==typeof e?e.call(this):e;n&&Object.keys(n).forEach(function(e){t[r](e,n[e])})},beforeDestroy:function(){for(var e in this._firestoreUnbinds)this._firestoreUnbinds[e]();this._firestoreUnbinds=null,this.$firestoreRefs=null}}),e.prototype[r]=function(e,t,n){this._firestoreUnbinds[e]&&this[i](e);var r=a({vm:this,key:e,ref:t,ops:c},n);return this.$firestoreRefs[e]=t,r},e.prototype[i]=function(e){this._firestoreUnbinds[e](),delete this._firestoreUnbinds[e],delete this.$firestoreRefs[e]}},e.getRef=o,e.rtdbPlugin=function(e,t){void 0===t&&(t={});var n=t.bindName;void 0===n&&(n="$rtdbBind");var r=t.unbindName;void 0===r&&(r="$rtdbUnbind");var i=e.config.optionMergeStrategies;i.firebase=i.provide,e.mixin({created:function(){!function(e){e.$firebaseRefs||(e.$firebaseRefs=Object.create(null),e._firebaseSources=Object.create(null),e._firebaseUnbinds=Object.create(null))}(this);var e=this.$options.firebase;if("function"==typeof e&&(e=e.call(this)),e)for(var t in e)this[n](t,e[t])},beforeDestroy:function(){for(var e in this._firebaseUnbinds)this._firebaseUnbinds[e]();this._firebaseSources=null,this._firebaseUnbinds=null,this.$firebaseRefs=null}}),e.prototype[n]=function(e,t){this._firebaseUnbinds[e]&&this[r](e);var n=u(this,e,t);return this._firebaseSources[e]=t,this.$firebaseRefs[e]=o(t),n},e.prototype[r]=function(e){!function(e,t){e._firebaseUnbinds[t](),delete e._firebaseSources[t],delete e._firebaseUnbinds[t]}(this,e)}},Object.defineProperty(e,"__esModule",{value:!0})});