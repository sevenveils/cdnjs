goog.provide("i18n.phonenumbers.AsYouTypeFormatter"),goog.require("goog.string.StringBuffer"),goog.require("i18n.phonenumbers.NumberFormat"),goog.require("i18n.phonenumbers.PhoneMetadata"),goog.require("i18n.phonenumbers.PhoneNumberUtil"),i18n.phonenumbers.AsYouTypeFormatter=function(t){this.DIGIT_PLACEHOLDER_="â€ˆ",this.DIGIT_PATTERN_=new RegExp(this.DIGIT_PLACEHOLDER_),this.currentOutput_="",this.formattingTemplate_=new goog.string.StringBuffer,this.currentFormattingPattern_="",this.accruedInput_=new goog.string.StringBuffer,this.accruedInputWithoutFormatting_=new goog.string.StringBuffer,this.ableToFormat_=!0,this.inputHasFormatting_=!1,this.isCompleteNumber_=!1,this.isExpectingCountryCallingCode_=!1,this.phoneUtil_=i18n.phonenumbers.PhoneNumberUtil.getInstance(),this.lastMatchPosition_=0,this.originalPosition_=0,this.positionToRemember_=0,this.prefixBeforeNationalNumber_=new goog.string.StringBuffer,this.shouldAddSpaceAfterNationalPrefix_=!1,this.extractedNationalPrefix_="",this.nationalNumber_=new goog.string.StringBuffer,this.possibleFormats_=[],this.defaultCountry_=t,this.currentMetadata_=this.getMetadataForRegion_(this.defaultCountry_),this.defaultMetadata_=this.currentMetadata_},i18n.phonenumbers.AsYouTypeFormatter.SEPARATOR_BEFORE_NATIONAL_NUMBER_=" ",i18n.phonenumbers.AsYouTypeFormatter.EMPTY_METADATA_=new i18n.phonenumbers.PhoneMetadata,i18n.phonenumbers.AsYouTypeFormatter.EMPTY_METADATA_.setInternationalPrefix("NA"),i18n.phonenumbers.AsYouTypeFormatter.ELIGIBLE_FORMAT_PATTERN_=new RegExp("^["+i18n.phonenumbers.PhoneNumberUtil.VALID_PUNCTUATION+"]*(\\$\\d["+i18n.phonenumbers.PhoneNumberUtil.VALID_PUNCTUATION+"]*)+$"),i18n.phonenumbers.AsYouTypeFormatter.NATIONAL_PREFIX_SEPARATORS_PATTERN_=/[- ]/,i18n.phonenumbers.AsYouTypeFormatter.MIN_LEADING_DIGITS_LENGTH_=3,i18n.phonenumbers.AsYouTypeFormatter.prototype.getMetadataForRegion_=function(t){var e=this.phoneUtil_.getCountryCodeForRegion(t),r=this.phoneUtil_.getRegionCodeForCountryCode(e),i=this.phoneUtil_.getMetadataForRegion(r);return null!=i?i:i18n.phonenumbers.AsYouTypeFormatter.EMPTY_METADATA_},i18n.phonenumbers.AsYouTypeFormatter.prototype.maybeCreateNewTemplate_=function(){for(var t=this.possibleFormats_.length,e=0;e<t;++e){var r=this.possibleFormats_[e],i=r.getPatternOrDefault();if(this.currentFormattingPattern_==i)return!1;if(this.createFormattingTemplate_(r))return this.currentFormattingPattern_=i,this.shouldAddSpaceAfterNationalPrefix_=i18n.phonenumbers.AsYouTypeFormatter.NATIONAL_PREFIX_SEPARATORS_PATTERN_.test(r.getNationalPrefixFormattingRule()),!(this.lastMatchPosition_=0)}return this.ableToFormat_=!1},i18n.phonenumbers.AsYouTypeFormatter.prototype.getAvailableFormats_=function(t){for(var e=this.isCompleteNumber_&&0==this.extractedNationalPrefix_.length&&0<this.currentMetadata_.intlNumberFormatCount()?this.currentMetadata_.intlNumberFormatArray():this.currentMetadata_.numberFormatArray(),r=e.length,i=0;i<r;++i){var n=e[i];0<this.extractedNationalPrefix_.length&&this.phoneUtil_.formattingRuleHasFirstGroupOnly(n.getNationalPrefixFormattingRuleOrDefault())&&!n.getNationalPrefixOptionalWhenFormatting()&&!n.hasDomesticCarrierCodeFormattingRule()||(0!=this.extractedNationalPrefix_.length||this.isCompleteNumber_||this.phoneUtil_.formattingRuleHasFirstGroupOnly(n.getNationalPrefixFormattingRuleOrDefault())||n.getNationalPrefixOptionalWhenFormatting())&&i18n.phonenumbers.AsYouTypeFormatter.ELIGIBLE_FORMAT_PATTERN_.test(n.getFormatOrDefault())&&this.possibleFormats_.push(n)}this.narrowDownPossibleFormats_(t)},i18n.phonenumbers.AsYouTypeFormatter.prototype.narrowDownPossibleFormats_=function(t){for(var e=[],r=t.length-i18n.phonenumbers.AsYouTypeFormatter.MIN_LEADING_DIGITS_LENGTH_,i=this.possibleFormats_.length,n=0;n<i;++n){var o=this.possibleFormats_[n];if(0!=o.leadingDigitsPatternCount()){var a=Math.min(r,o.leadingDigitsPatternCount()-1),s=o.getLeadingDigitsPattern(a);0==t.search(s)&&e.push(this.possibleFormats_[n])}else e.push(this.possibleFormats_[n])}this.possibleFormats_=e},i18n.phonenumbers.AsYouTypeFormatter.prototype.createFormattingTemplate_=function(t){var e=t.getPatternOrDefault();this.formattingTemplate_.clear();var r=this.getFormattingTemplate_(e,t.getFormatOrDefault());return 0<r.length&&(this.formattingTemplate_.append(r),!0)},i18n.phonenumbers.AsYouTypeFormatter.prototype.getFormattingTemplate_=function(t,e){var r="999999999999999".match(t)[0];if(r.length<this.nationalNumber_.getLength())return"";var i=r.replace(new RegExp(t,"g"),e);return i=i.replace(new RegExp("9","g"),this.DIGIT_PLACEHOLDER_)},i18n.phonenumbers.AsYouTypeFormatter.prototype.clear=function(){this.currentOutput_="",this.accruedInput_.clear(),this.accruedInputWithoutFormatting_.clear(),this.formattingTemplate_.clear(),this.lastMatchPosition_=0,this.currentFormattingPattern_="",this.prefixBeforeNationalNumber_.clear(),this.extractedNationalPrefix_="",this.nationalNumber_.clear(),this.ableToFormat_=!0,this.inputHasFormatting_=!1,this.positionToRemember_=0,this.originalPosition_=0,this.isCompleteNumber_=!1,this.isExpectingCountryCallingCode_=!1,this.possibleFormats_=[],this.shouldAddSpaceAfterNationalPrefix_=!1,this.currentMetadata_!=this.defaultMetadata_&&(this.currentMetadata_=this.getMetadataForRegion_(this.defaultCountry_))},i18n.phonenumbers.AsYouTypeFormatter.prototype.inputDigit=function(t){return this.currentOutput_=this.inputDigitWithOptionToRememberPosition_(t,!1),this.currentOutput_},i18n.phonenumbers.AsYouTypeFormatter.prototype.inputDigitAndRememberPosition=function(t){return this.currentOutput_=this.inputDigitWithOptionToRememberPosition_(t,!0),this.currentOutput_},i18n.phonenumbers.AsYouTypeFormatter.prototype.inputDigitWithOptionToRememberPosition_=function(t,e){if(this.accruedInput_.append(t),e&&(this.originalPosition_=this.accruedInput_.getLength()),this.isDigitOrLeadingPlusSign_(t)?t=this.normalizeAndAccrueDigitsAndPlusSign_(t,e):(this.ableToFormat_=!1,this.inputHasFormatting_=!0),!this.ableToFormat_){if(this.inputHasFormatting_)return this.accruedInput_.toString();if(this.attemptToExtractIdd_()){if(this.attemptToExtractCountryCallingCode_())return this.attemptToChoosePatternWithPrefixExtracted_()}else if(this.ableToExtractLongerNdd_())return this.prefixBeforeNationalNumber_.append(i18n.phonenumbers.AsYouTypeFormatter.SEPARATOR_BEFORE_NATIONAL_NUMBER_),this.attemptToChoosePatternWithPrefixExtracted_();return this.accruedInput_.toString()}switch(this.accruedInputWithoutFormatting_.getLength()){case 0:case 1:case 2:return this.accruedInput_.toString();case 3:if(!this.attemptToExtractIdd_())return this.extractedNationalPrefix_=this.removeNationalPrefixFromNationalNumber_(),this.attemptToChooseFormattingPattern_();this.isExpectingCountryCallingCode_=!0;default:if(this.isExpectingCountryCallingCode_)return this.attemptToExtractCountryCallingCode_()&&(this.isExpectingCountryCallingCode_=!1),this.prefixBeforeNationalNumber_.toString()+this.nationalNumber_.toString();if(0<this.possibleFormats_.length){var r=this.inputDigitHelper_(t),i=this.attemptToFormatAccruedDigits_();return 0<i.length?i:(this.narrowDownPossibleFormats_(this.nationalNumber_.toString()),this.maybeCreateNewTemplate_()?this.inputAccruedNationalNumber_():this.ableToFormat_?this.appendNationalNumber_(r):this.accruedInput_.toString())}return this.attemptToChooseFormattingPattern_()}},i18n.phonenumbers.AsYouTypeFormatter.prototype.attemptToChoosePatternWithPrefixExtracted_=function(){return this.ableToFormat_=!0,this.isExpectingCountryCallingCode_=!1,this.possibleFormats_=[],this.lastMatchPosition_=0,this.formattingTemplate_.clear(),this.currentFormattingPattern_="",this.attemptToChooseFormattingPattern_()},i18n.phonenumbers.AsYouTypeFormatter.prototype.getExtractedNationalPrefix_=function(){return this.extractedNationalPrefix_},i18n.phonenumbers.AsYouTypeFormatter.prototype.ableToExtractLongerNdd_=function(){if(0<this.extractedNationalPrefix_.length){var t=this.nationalNumber_.toString();this.nationalNumber_.clear(),this.nationalNumber_.append(this.extractedNationalPrefix_),this.nationalNumber_.append(t);var e=this.prefixBeforeNationalNumber_.toString(),r=e.lastIndexOf(this.extractedNationalPrefix_);this.prefixBeforeNationalNumber_.clear(),this.prefixBeforeNationalNumber_.append(e.substring(0,r))}return this.extractedNationalPrefix_!=this.removeNationalPrefixFromNationalNumber_()},i18n.phonenumbers.AsYouTypeFormatter.prototype.isDigitOrLeadingPlusSign_=function(t){return i18n.phonenumbers.PhoneNumberUtil.CAPTURING_DIGIT_PATTERN.test(t)||1==this.accruedInput_.getLength()&&i18n.phonenumbers.PhoneNumberUtil.PLUS_CHARS_PATTERN.test(t)},i18n.phonenumbers.AsYouTypeFormatter.prototype.attemptToFormatAccruedDigits_=function(){for(var t=this.nationalNumber_.toString(),e=this.possibleFormats_.length,r=0;r<e;++r){var i=this.possibleFormats_[r],n=i.getPatternOrDefault();if(new RegExp("^(?:"+n+")$").test(t)){this.shouldAddSpaceAfterNationalPrefix_=i18n.phonenumbers.AsYouTypeFormatter.NATIONAL_PREFIX_SEPARATORS_PATTERN_.test(i.getNationalPrefixFormattingRule());var o=t.replace(new RegExp(n,"g"),i.getFormat());return this.appendNationalNumber_(o)}}return""},i18n.phonenumbers.AsYouTypeFormatter.prototype.appendNationalNumber_=function(t){var e=this.prefixBeforeNationalNumber_.getLength();return this.shouldAddSpaceAfterNationalPrefix_&&0<e&&this.prefixBeforeNationalNumber_.toString().charAt(e-1)!=i18n.phonenumbers.AsYouTypeFormatter.SEPARATOR_BEFORE_NATIONAL_NUMBER_?this.prefixBeforeNationalNumber_+i18n.phonenumbers.AsYouTypeFormatter.SEPARATOR_BEFORE_NATIONAL_NUMBER_+t:this.prefixBeforeNationalNumber_+t},i18n.phonenumbers.AsYouTypeFormatter.prototype.getRememberedPosition=function(){if(!this.ableToFormat_)return this.originalPosition_;for(var t=0,e=0,r=this.accruedInputWithoutFormatting_.toString(),i=this.currentOutput_.toString();t<this.positionToRemember_&&e<i.length;)r.charAt(t)==i.charAt(e)&&t++,e++;return e},i18n.phonenumbers.AsYouTypeFormatter.prototype.attemptToChooseFormattingPattern_=function(){var t=this.nationalNumber_.toString();if(t.length>=i18n.phonenumbers.AsYouTypeFormatter.MIN_LEADING_DIGITS_LENGTH_){this.getAvailableFormats_(t);var e=this.attemptToFormatAccruedDigits_();return 0<e.length?e:this.maybeCreateNewTemplate_()?this.inputAccruedNationalNumber_():this.accruedInput_.toString()}return this.appendNationalNumber_(t)},i18n.phonenumbers.AsYouTypeFormatter.prototype.inputAccruedNationalNumber_=function(){var t=this.nationalNumber_.toString(),e=t.length;if(0<e){for(var r="",i=0;i<e;i++)r=this.inputDigitHelper_(t.charAt(i));return this.ableToFormat_?this.appendNationalNumber_(r):this.accruedInput_.toString()}return this.prefixBeforeNationalNumber_.toString()},i18n.phonenumbers.AsYouTypeFormatter.prototype.isNanpaNumberWithNationalPrefix_=function(){if(1!=this.currentMetadata_.getCountryCode())return!1;var t=this.nationalNumber_.toString();return"1"==t.charAt(0)&&"0"!=t.charAt(1)&&"1"!=t.charAt(1)},i18n.phonenumbers.AsYouTypeFormatter.prototype.removeNationalPrefixFromNationalNumber_=function(){var t=this.nationalNumber_.toString(),e=0;if(this.isNanpaNumberWithNationalPrefix_())e=1,this.prefixBeforeNationalNumber_.append("1").append(i18n.phonenumbers.AsYouTypeFormatter.SEPARATOR_BEFORE_NATIONAL_NUMBER_),this.isCompleteNumber_=!0;else if(this.currentMetadata_.hasNationalPrefixForParsing()){var r=new RegExp("^(?:"+this.currentMetadata_.getNationalPrefixForParsing()+")"),i=t.match(r);null!=i&&null!=i[0]&&0<i[0].length&&(this.isCompleteNumber_=!0,e=i[0].length,this.prefixBeforeNationalNumber_.append(t.substring(0,e)))}return this.nationalNumber_.clear(),this.nationalNumber_.append(t.substring(e)),t.substring(0,e)},i18n.phonenumbers.AsYouTypeFormatter.prototype.attemptToExtractIdd_=function(){var t=this.accruedInputWithoutFormatting_.toString(),e=new RegExp("^(?:\\"+i18n.phonenumbers.PhoneNumberUtil.PLUS_SIGN+"|"+this.currentMetadata_.getInternationalPrefix()+")"),r=t.match(e);if(null!=r&&null!=r[0]&&0<r[0].length){this.isCompleteNumber_=!0;var i=r[0].length;return this.nationalNumber_.clear(),this.nationalNumber_.append(t.substring(i)),this.prefixBeforeNationalNumber_.clear(),this.prefixBeforeNationalNumber_.append(t.substring(0,i)),t.charAt(0)!=i18n.phonenumbers.PhoneNumberUtil.PLUS_SIGN&&this.prefixBeforeNationalNumber_.append(i18n.phonenumbers.AsYouTypeFormatter.SEPARATOR_BEFORE_NATIONAL_NUMBER_),!0}return!1},i18n.phonenumbers.AsYouTypeFormatter.prototype.attemptToExtractCountryCallingCode_=function(){if(0==this.nationalNumber_.getLength())return!1;var t=new goog.string.StringBuffer,e=this.phoneUtil_.extractCountryCode(this.nationalNumber_,t);if(0==e)return!1;this.nationalNumber_.clear(),this.nationalNumber_.append(t.toString());var r=this.phoneUtil_.getRegionCodeForCountryCode(e);i18n.phonenumbers.PhoneNumberUtil.REGION_CODE_FOR_NON_GEO_ENTITY==r?this.currentMetadata_=this.phoneUtil_.getMetadataForNonGeographicalRegion(e):r!=this.defaultCountry_&&(this.currentMetadata_=this.getMetadataForRegion_(r));var i=""+e;return this.prefixBeforeNationalNumber_.append(i).append(i18n.phonenumbers.AsYouTypeFormatter.SEPARATOR_BEFORE_NATIONAL_NUMBER_),!(this.extractedNationalPrefix_="")},i18n.phonenumbers.AsYouTypeFormatter.prototype.normalizeAndAccrueDigitsAndPlusSign_=function(t,e){var r;return t==i18n.phonenumbers.PhoneNumberUtil.PLUS_SIGN?(r=t,this.accruedInputWithoutFormatting_.append(t)):(r=i18n.phonenumbers.PhoneNumberUtil.DIGIT_MAPPINGS[t],this.accruedInputWithoutFormatting_.append(r),this.nationalNumber_.append(r)),e&&(this.positionToRemember_=this.accruedInputWithoutFormatting_.getLength()),r},i18n.phonenumbers.AsYouTypeFormatter.prototype.inputDigitHelper_=function(t){var e=this.formattingTemplate_.toString();if(0<=e.substring(this.lastMatchPosition_).search(this.DIGIT_PATTERN_)){var r=e.search(this.DIGIT_PATTERN_),i=e.replace(this.DIGIT_PATTERN_,t);return this.formattingTemplate_.clear(),this.formattingTemplate_.append(i),this.lastMatchPosition_=r,i.substring(0,this.lastMatchPosition_+1)}return 1==this.possibleFormats_.length&&(this.ableToFormat_=!1),this.currentFormattingPattern_="",this.accruedInput_.toString()};